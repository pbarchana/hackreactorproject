<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Test</title>
        <script type="text/javascript" src="d3/d3.js"></script>
        <style>

        .node {
          stroke: #fff;
          stroke-width: 3px;
        }

        .link {
          stroke-width: 5px;
          stroke: #999;
          stroke-opacity: 0.6;
        }

        </style>
    </head>
    <body>
        <script type="text/javascript">

          //View window width and height
          var viewWidth = 800; //set to a percentage for dynamic resizing
          var viewHeight = 600;

          var force = d3.layout.force()
              .charge(-120)
              .linkDistance(30)
              .size([viewWidth, viewHeight]);

          //Create view window SVG
          var svg =  d3.select('body')
                        .append('svg')
                        .attr('width', viewWidth)
                        .attr('height', viewHeight)
                        .style('border', '1px solid black');
                        // .call(d3.behavior.zoom().on("zoom", redraw));

          d3.json('serverinfo.json', function(error, data){

            if(error){console.log(error);}

            //map mac addresses to nodes
            var map = mapMac(data.nodes);

            //set link source and target to node instead of mac address
            data.links.forEach(function(l){
              l.source = map.get(l.source);
              l.target = map.get(l.target);
            });

            // Start the force physics
            force
              .nodes(data.nodes)
              .links(data.links)
              .start();

            var links = svg.append('g').selectAll(".link")
                  .data(force.links())
                  .enter().append("line")
                  .attr("class", "link");


            var nodes = svg.append('g').selectAll(".node")
                  .data(force.nodes())
                  .enter().append("circle")
                  .attr("class", "node")
                  .attr("r", 9)
                  .attr("fill", "blue")
                  .call(force.drag);


            force.on("tick", function() {
                links.attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });

                nodes.attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; });
            });

          });

          //function to map MAC address of nic to containing host
          var mapMac = function(nodes){
            var nodesMap = d3.map();
            nodes.forEach(function(n){
              var node = n;
              var nics = n.components.nics;
              nics.forEach(function(n){
                nodesMap.set(n.mac, node);
              });
            });
            return nodesMap;
          };

            //zoom function
            // function redraw(){
            //   console.log("translate: ", d3.event.translate, "scale:", d3.event.scale);
            //   svg.selectAll('circle').attr("transform",
            //         "translate(" + d3.event.translate + ")" +
            //         " scale(" + d3.event.scale + ")");
            // }

        </script>
    </body>
</html>